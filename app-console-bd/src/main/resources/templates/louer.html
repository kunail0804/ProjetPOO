<!doctype html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: layout('Louer', ~{::section})}">

<section>

  <div class="panel soft">
    <div class="panel-head">
      <div>
        <h1 class="h1">Louer</h1>
        <div class="muted small" th:if="${louable != null}">
          Louable #<strong th:text="${idLouable}">0</strong>
          · <strong th:text="${louable.type()}">Type</strong>
          · <span th:text="${louable.lieuPrincipal()}">Lieu</span>
          · <span class="badge" th:text="${louable.statut()}">STATUT</span>
        </div>
      </div>

      <div class="btnrow">
        <a class="btn" th:href="@{/louables/{id}(id=${idLouable})}">← Retour</a>
      </div>
    </div>

    <div class="hr"></div>

    <!-- Messages -->
    <div class="alert err" th:if="${erreur}" th:text="${erreur}">Erreur</div>
    <div class="alert ok" th:if="${succes}" th:text="${succes}">OK</div>

    <div class="spacer"></div>

    <div class="louer-grid" th:if="${louable != null}">

      <!-- Disponibilités -->
      <article class="card">
        <div class="panel-head">
          <div>
            <div class="h2">Disponibilités</div>
            <div class="muted small">
              Jours en vert = au moins une disponibilité non réservée couvre la date.
            </div>
          </div>
        </div>

        <div class="spacer"></div>

        <!-- Navigation mois -->
        <div class="cal-head">
          <div class="btnrow">
            <button type="button" class="btn" id="prevMonth">←</button>
            <button type="button" class="btn" id="nextMonth">→</button>
          </div>

          <div class="cal-title">
            <div class="h3" style="margin:0;" id="calLabel">Mois</div>
            <div class="muted small">Change de mois si besoin</div>
          </div>

          <div class="cal-picker">
            <input class="input" type="month" id="monthPicker" />
          </div>
        </div>

        <div class="spacer"></div>

        <div class="cal-wrap">
          <table class="cal" aria-label="Calendrier des disponibilités">
            <thead>
            <tr>
              <th>LUN</th><th>MAR</th><th>MER</th><th>JEU</th><th>VEN</th><th>SAM</th><th>DIM</th>
            </tr>
            </thead>
            <tbody id="calBody">
            <!-- rempli en JS -->
            </tbody>
          </table>
        </div>

        <div class="legend">
          <span class="chip"><span class="dot" style="background: rgba(53,247,166,.9)"></span> Disponible</span>
          <span class="chip"><span class="dot" style="background: rgba(255,255,255,.25)"></span> Hors mois</span>
        </div>

        <input type="hidden" id="idLouable" th:value="${idLouable}" />
      </article>

      <!-- Formulaire location -->
      <article class="card">
        <div class="h2">Créer une location</div>

        <form class="form" method="post" th:action="@{/louables/{id}/louer(id=${idLouable})}">
          <!-- cohérence URL vs hidden -->
          <input type="hidden" name="idLouable" th:value="${idLouable}" />

          <div class="field">
            <div class="label">Assurance</div>
            <select name="idAssurance" required>
              <option value="" disabled selected>Choisir…</option>
              <option th:each="a : ${assurances}"
                      th:value="${a.idAssurance}"
                      th:text="${a.nom}"
                      th:attr="data-tarif=${a.tarifJournalier}">
                Assurance
              </option>
            </select>
          </div>

          <div class="row">
            <div class="col field">
              <div class="label">Date début</div>
              <input class="input" type="date" name="dateDebut" required />
            </div>
            <div class="col field">
              <div class="label">Date fin</div>
              <input class="input" type="date" name="dateFin" required />
            </div>
          </div>

          <div class="field">
            <div class="label">Lieu de dépôt (optionnel)</div>
            <input class="input" type="text" name="lieuDepotOptionnel" placeholder="Ex: Toulouse centre" />
          </div>

          <div class="hr"></div>

          <div class="card-title" style="margin-top:10px;">Estimation prix</div>

          <div class="kv">
            <div class="kv-row">
              <div class="k">Durée</div>
              <div class="v"><strong id="est_nbjours">0</strong> jour(s)</div>
            </div>

            <!-- AJOUT : assurance -->
            <div class="kv-row">
              <div class="k">Assurance (/jour)</div>
              <div class="v"><strong id="est_ass_jour">0.00</strong> € / jour</div>
            </div>

            <div class="kv-row">
              <div class="k">Base assurance</div>
              <div class="v"><strong id="est_ass_base">0.00</strong> €</div>
            </div>
            <!-- FIN AJOUT -->

            <div class="kv-row">
              <div class="k">Base (louable + assurance)</div>
              <div class="v"><strong id="est_base">0.00</strong> €</div>
            </div>

            <div class="kv-row">
              <div class="k">Commission 10%</div>
              <div class="v"><strong id="est_var">0.00</strong> €</div>
            </div>

            <div class="kv-row">
              <div class="k">Forfait 2€ / jour</div>
              <div class="v"><strong id="est_fixe">0.00</strong> €</div>
            </div>

            <div class="kv-row">
              <div class="k">Total client</div>
              <div class="v"><strong id="est_total">0.00</strong> €</div>
            </div>

            <div class="kv-row">
              <div class="k">Prix/jour (louable)</div>
              <div class="v">
                <span th:text="${#numbers.formatDecimal(louable.prixJour(), 1, 2)}">0.00</span> € / jour
              </div>
            </div>
          </div>

          <div class="btnrow">
            <button class="btn primary" type="submit">Valider la location</button>
            <a class="btn ghost" th:href="@{/louables/{id}(id=${idLouable})}">Annuler</a>
          </div>
        </form>

        <!-- Résumé contrat (quand location créée) -->
        <div class="spacer"></div>
        <div class="alert ok" th:if="${contrat != null}">
          Contrat #<strong th:text="${contrat.id}">0</strong>
          · du <strong th:text="${#temporals.format(contrat.dateDebut, 'dd/MM/yyyy')}">01/01/2026</strong>
          au <strong th:text="${#temporals.format(contrat.dateFin, 'dd/MM/yyyy')}">02/01/2026</strong>
          · Prise: <strong th:text="${contrat.lieuPrise}">X</strong>
          · Dépôt: <strong th:text="${contrat.lieuDepot}">Y</strong>
          · Assurance: <strong th:text="${contrat.assuranceNom}">Assurance</strong>
          <span th:if="${prixContrat != null}">· Prix: <strong th:text="${#numbers.formatDecimal(prixContrat, 1, 2)}">0.00</strong> €</span>
        </div>
      </article>

    </div>
  </div>

  <script th:inline="javascript">
    /*<![CDATA[*/
    (function(){
      const idLouable = document.getElementById('idLouable')?.value;
      const calBody = document.getElementById('calBody');
      const calLabel = document.getElementById('calLabel');
      const monthPicker = document.getElementById('monthPicker');
      const prevBtn = document.getElementById('prevMonth');
      const nextBtn = document.getElementById('nextMonth');

      if(!idLouable || !calBody) return;

      const monthsFR = [
        "janvier","février","mars","avril","mai","juin",
        "juillet","août","septembre","octobre","novembre","décembre"
      ];

      const pad2 = (n)=> (n<10?("0"+n):(""+n));
      const ymd = (d)=> `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;

      const mondayIndex = (d)=>{
        const js = d.getDay();
        return (js === 0) ? 6 : (js - 1);
      };

      const parseDate = (s)=>{
        if(!s) return null;
        const m = /^(\d{4})-(\d{2})-(\d{2})/.exec(String(s));
        if(!m) return null;
        return new Date(Number(m[1]), Number(m[2]) - 1, Number(m[3]));
      };

      async function loadAvailableSet(){
        const res = await fetch(`/louer/disponibilites?idLouable=${encodeURIComponent(idLouable)}`, {
          headers: { "Accept": "application/json" }
        });
        if(!res.ok) throw new Error("Erreur chargement disponibilités");
        const arr = await res.json();

        const set = new Set();

        for(const item of (Array.isArray(arr) ? arr : [])){
          const d1 = parseDate(item.dateDebut ?? item.date_debut ?? item.debut ?? item.startDate);
          const d2 = parseDate(item.dateFin ?? item.date_fin ?? item.fin ?? item.endDate);
          const reservedRaw = (item.estReservee ?? item.reservee ?? item.isReserved ?? item.reserved);
          const reserved = String(reservedRaw).toLowerCase() === "true" || reservedRaw === 1;

          if(reserved) continue;
          if(!d1 || !d2) continue;

          const cur = new Date(d1.getFullYear(), d1.getMonth(), d1.getDate());
          const end = new Date(d2.getFullYear(), d2.getMonth(), d2.getDate());
          while(cur <= end){
            set.add(ymd(cur));
            cur.setDate(cur.getDate() + 1);
          }
        }
        return set;
      }

      let availableSet = new Set();
      let view = new Date();
      view = new Date(view.getFullYear(), view.getMonth(), 1);

      function updateLabel(){
        calLabel.textContent = `${monthsFR[view.getMonth()]} ${view.getFullYear()}`;
        monthPicker.value = `${view.getFullYear()}-${pad2(view.getMonth()+1)}`;
      }

      function render(){
        updateLabel();

        const first = new Date(view.getFullYear(), view.getMonth(), 1);
        const startOffset = mondayIndex(first);
        const gridStart = new Date(first);
        gridStart.setDate(first.getDate() - startOffset);

        calBody.innerHTML = "";
        const cur = new Date(gridStart);

        for(let week=0; week<6; week++){
          const tr = document.createElement("tr");
          for(let i=0; i<7; i++){
            const td = document.createElement("td");
            const key = ymd(cur);

            const inMonth = cur.getMonth() === view.getMonth();
            if(!inMonth) td.classList.add("day-off");
            if(inMonth && availableSet.has(key)) td.classList.add("day-avail");

            td.textContent = String(cur.getDate());
            tr.appendChild(td);
            cur.setDate(cur.getDate()+1);
          }
          calBody.appendChild(tr);
        }
      }

      function addMonths(delta){
        view = new Date(view.getFullYear(), view.getMonth() + delta, 1);
        render();
      }

      prevBtn?.addEventListener("click", ()=> addMonths(-1));
      nextBtn?.addEventListener("click", ()=> addMonths(1));
      monthPicker?.addEventListener("change", ()=>{
        const v = monthPicker.value;
        const m = /^(\d{4})-(\d{2})$/.exec(v);
        if(!m) return;
        view = new Date(Number(m[1]), Number(m[2]) - 1, 1);
        render();
      });

      loadAvailableSet()
        .then((set)=>{ availableSet = set; render(); })
        .catch(()=>{ availableSet = new Set(); render(); });

      // ===== Estimation prix en direct (louable + assurance) =====
      const prixJourLouableRaw = /*[[${louable != null ? louable.prixJour() : 0}]]*/ 0;
      const prixJourLouable = Number(prixJourLouableRaw) || 0;

      const pct = 0.10;
      const fixeParJour = 2;

      const inputDebut = document.querySelector('input[name="dateDebut"]');
      const inputFin = document.querySelector('input[name="dateFin"]');
      const selectAssurance = document.querySelector('select[name="idAssurance"]');

      const elJ = document.getElementById("est_nbjours");
      const elBase = document.getElementById("est_base");
      const elVar = document.getElementById("est_var");
      const elFixe = document.getElementById("est_fixe");
      const elTotal = document.getElementById("est_total");

      // AJOUT : éléments assurance
      const elAssJour = document.getElementById("est_ass_jour");
      const elAssBase = document.getElementById("est_ass_base");

      function parseYMD(s){
        const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(String(s||""));
        if(!m) return null;
        return new Date(Number(m[1]), Number(m[2])-1, Number(m[3]));
      }

      function round2(n){
        return Math.round((n + Number.EPSILON) * 100) / 100;
      }

      function getTarifAssuranceJour(){
        const opt = selectAssurance?.selectedOptions?.[0];
        const t = opt?.getAttribute("data-tarif");
        const n = Number(t);
        return Number.isFinite(n) ? n : 0;
      }

      function resetEstimation(){
        if(elJ) elJ.textContent = "0";
        if(elBase) elBase.textContent = "0.00";
        if(elVar) elVar.textContent = "0.00";
        if(elFixe) elFixe.textContent = "0.00";
        if(elTotal) elTotal.textContent = "0.00";
        if(elAssJour) elAssJour.textContent = "0.00";
        if(elAssBase) elAssBase.textContent = "0.00";
      }

      function updateEstimation(){
        const d1 = parseYMD(inputDebut?.value);
        const d2 = parseYMD(inputFin?.value);

        if(!d1 || !d2 || d2 < d1){
          resetEstimation();
          return;
        }

        // inclusif => +1
        const diff = Math.floor((d2.getTime() - d1.getTime()) / (1000*60*60*24));
        const nbJours = diff + 1;

        const prixJourAssurance = getTarifAssuranceJour();
        const baseAssurance = prixJourAssurance * nbJours;

        const base = (prixJourLouable + prixJourAssurance) * nbJours;
        const commissionVar = base * pct;
        const commissionFixe = fixeParJour * nbJours;
        const total = base + commissionVar + commissionFixe;

        if(elJ) elJ.textContent = String(nbJours);
        if(elBase) elBase.textContent = round2(base).toFixed(2);
        if(elVar) elVar.textContent = round2(commissionVar).toFixed(2);
        if(elFixe) elFixe.textContent = round2(commissionFixe).toFixed(2);
        if(elTotal) elTotal.textContent = round2(total).toFixed(2);

        // AJOUT : affichage assurance
        if(elAssJour) elAssJour.textContent = round2(prixJourAssurance).toFixed(2);
        if(elAssBase) elAssBase.textContent = round2(baseAssurance).toFixed(2);
      }

      inputDebut?.addEventListener("change", updateEstimation);
      inputFin?.addEventListener("change", updateEstimation);
      selectAssurance?.addEventListener("change", updateEstimation);
      updateEstimation();

    })();
    /*]]>*/
  </script>

</section>
</html>