<!doctype html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Louer un véhicule</title>
    <style>
        .ok { color: green; }
        .err { color: red; }
        .box { border: 1px solid #ddd; padding: 12px; border-radius: 8px; }
        .muted { color: #666; font-size: 0.9em; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .cal { border-collapse: collapse; width: 100%; }
        .cal th, .cal td { border: 1px solid #e5e5e5; padding: 8px; text-align: center; }
        .cal th { background: #f7f7f7; }
        .day-off { background: #fafafa; color: #bbb; }
        .day-avail { background: #e8fff0; }
        .legend { display:flex; gap:12px; align-items:center; margin-top:8px; }
        .chip { display:inline-flex; gap:6px; align-items:center; }
        .dot { width:10px; height:10px; border-radius:50%; display:inline-block; }
    </style>
</head>
<body>

<h1>Louer un véhicule</h1>

<p><a th:href="@{/}">← Retour accueil</a></p>

<div th:if="${succes}">
    <p class="ok" th:text="${succes}">Succès</p>
</div>
<div th:if="${erreur}">
    <p class="err" th:text="${erreur}">Erreur</p>
</div>

<hr>

<form th:action="@{/louer}" method="post" class="box">

    <div>
        <label for="idLoueur"><strong>Loueur</strong></label><br>
        <select id="idLoueur" name="idLoueur" required>
            <option value="" disabled selected>-- Choisir un loueur --</option>
            <option th:each="u : ${loueurs}"
                    th:value="${u.get('idUtilisateur')}"
                    th:text="${'ID ' + u.get('idUtilisateur') + ' - ' + u.get('prenom') + ' ' + u.get('nom')}">
                Loueur
            </option>
        </select>
    </div>

    <br>

    <div>
        <label for="idLouable"><strong>Véhicule (louable)</strong></label><br>
        <select id="idLouable" name="idLouable" required>
            <option value="" disabled selected>-- Choisir un véhicule --</option>
            <option th:each="l : ${louables}"
                    th:value="${l.get('idLouable')}"
                    th:attr="data-lieu=${l.get('lieuPrincipal')}"
                    th:text="${'ID ' + l.get('idLouable')
                        + ' - ' + (l.get('marque') != null ? l.get('marque') : '')
                        + ' ' + (l.get('modele') != null ? l.get('modele') : '')
                        + ' (' + (l.get('immatriculation') != null ? l.get('immatriculation') : '') + ')'
                        + ' - ' + (l.get('prixJour') != null ? l.get('prixJour') : '?') + '€/jour'
                        + ' - ' + (l.get('statut') != null ? l.get('statut') : '')}">
                Louable
            </option>
        </select>
        <p class="muted">Quand tu sélectionnes un véhicule, les disponibilités s’affichent juste en dessous.</p>
    </div>

    <br>

    <div>
        <label><strong>Lieu de prise (fixe)</strong></label><br>
        <input id="lieuPriseAffiche" type="text" readonly value="">
        <p class="muted">Ce champ vient de <code>LOUABLE.lieuPrincipal</code> et sera forcé dans le contrat.</p>
    </div>

    <br>

    <div>
        <label for="idAssurance"><strong>Assurance</strong></label><br>
        <select id="idAssurance" name="idAssurance" required>
            <option value="" disabled selected>-- Choisir --</option>
            <option th:each="a : ${assurances}"
                    th:value="${a.get('idAssurance')}"
                    th:text="${a.get('nom') + ' - ' + a.get('tarifJournalier') + '€/jour'}">
                Assurance
            </option>
        </select>
    </div>

    <br>

    <div class="grid">
        <div>
            <label for="dateDebut"><strong>Date début</strong></label><br>
            <input id="dateDebut" name="dateDebut" type="date" required>
        </div>

        <div>
            <label for="dateFin"><strong>Date fin</strong></label><br>
            <input id="dateFin" name="dateFin" type="date" required>
        </div>
    </div>

    <br>

    <div>
        <label for="lieuDepotOptionnel"><strong>Lieu de dépôt (optionnel)</strong></label><br>
        <input id="lieuDepotOptionnel" name="lieuDepotOptionnel" type="text" placeholder="Ex: Toulouse">
        <p class="muted">Variante A : si vide, dépôt = lieu de prise.</p>
    </div>

    <br>

    <button type="submit">Confirmer la location</button>
</form>

<hr>

<h2>Disponibilités</h2>

<div class="box">
    <div id="disposBox">
        <p class="muted">Choisis un véhicule pour voir ses créneaux.</p>
    </div>

    <div id="calendarBox" style="margin-top:14px;"></div>

    <div class="legend">
        <span class="chip"><span class="dot" style="background:#e8fff0;"></span>Jours disponibles</span>
        <span class="chip"><span class="dot" style="background:#fafafa;"></span>Hors mois</span>
    </div>
</div>

<hr>

<div th:if="${contrat != null}">
    <h2>Résumé contrat</h2>
    <ul>
        <li>Date début : <span th:text="${contrat.get('dateDebut')}">dateDebut</span></li>
        <li>Date fin : <span th:text="${contrat.get('dateFin')}">dateFin</span></li>
        <li>Lieu prise : <span th:text="${contrat.get('lieuPrise')}">lieuPrise</span></li>
        <li>Lieu dépôt : <span th:text="${contrat.get('lieuDepot')}">lieuDepot</span></li>
        <li>Assurance : <span th:text="${contrat.get('assuranceNom')}">assurance</span></li>
    </ul>
</div>

<script>
    const selectLouable = document.getElementById('idLouable');
    const disposBox = document.getElementById('disposBox');
    const calendarBox = document.getElementById('calendarBox');
    const lieuPriseAffiche = document.getElementById('lieuPriseAffiche');

    const fmt = new Intl.DateTimeFormat('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });

    function normalizeToYMD(s) {
        // Accepte:
        // - "2026-01-05"
        // - "2026-01-05 00:00:00"
        // - "2026-01-05T00:00:00.000+00:00"
        if (!s) return '';
        let t = String(s).trim();
        if (t.includes('T')) t = t.split('T')[0];
        if (t.includes(' ')) t = t.split(' ')[0];
        return t; // "YYYY-MM-DD"
    }

    function parseISODate(isoLike) {
        const iso = normalizeToYMD(isoLike);
        const [y, m, d] = (iso || '').split('-').map(Number);
        return new Date(y || 1970, (m || 1) - 1, d || 1);
    }

    function formatISO(isoLike) {
        return fmt.format(parseISODate(isoLike));
    }

    function escapeHtml(str) {
        return (str || '')
            .replaceAll('&','&amp;')
            .replaceAll('<','&lt;')
            .replaceAll('>','&gt;')
            .replaceAll('"','&quot;')
            .replaceAll("'","&#039;");
    }

    function buildAvailSet(ranges) {
        const set = new Set();
        for (const r of ranges) {
            const start = parseISODate(r.dateDebut);
            const end = parseISODate(r.dateFin);

            const cur = new Date(start.getTime());
            while (cur <= end) {
                const y = cur.getFullYear();
                const m = String(cur.getMonth() + 1).padStart(2, '0');
                const d = String(cur.getDate()).padStart(2, '0');
                set.add(`${y}-${m}-${d}`);
                cur.setDate(cur.getDate() + 1);
            }
        }
        return set;
    }

    function renderCalendarForMonth(year, monthIndex0, availSet) {
        const first = new Date(year, monthIndex0, 1);
        const last = new Date(year, monthIndex0 + 1, 0);

        const monthName = new Intl.DateTimeFormat('fr-FR', { month: 'long', year: 'numeric' }).format(first);

        const dayOfWeek = (d) => (d.getDay() + 6) % 7; // lundi=0

        let html = `<h3 style="margin:0 0 8px 0; text-transform: capitalize;">${escapeHtml(monthName)}</h3>`;
        html += `<table class="cal"><thead><tr>
            <th>Lun</th><th>Mar</th><th>Mer</th><th>Jeu</th><th>Ven</th><th>Sam</th><th>Dim</th>
        </tr></thead><tbody>`;

        let cur = new Date(year, monthIndex0, 1 - dayOfWeek(first));
        for (let week = 0; week < 6; week++) {
            html += "<tr>";
            for (let i = 0; i < 7; i++) {
                const inMonth = cur.getMonth() === monthIndex0;
                const y = cur.getFullYear();
                const m = String(cur.getMonth() + 1).padStart(2, '0');
                const d = String(cur.getDate()).padStart(2, '0');
                const key = `${y}-${m}-${d}`;

                let cls = "";
                if (!inMonth) cls = "day-off";
                else if (availSet.has(key)) cls = "day-avail";

                html += `<td class="${cls}">${cur.getDate()}</td>`;
                cur.setDate(cur.getDate() + 1);
            }
            html += "</tr>";
            if (cur.getMonth() !== monthIndex0 && cur > last) break;
        }

        html += "</tbody></table>";
        return html;
    }

    function renderDispos(ranges) {
        if (!ranges || ranges.length === 0) {
            disposBox.innerHTML = '<p>Aucun créneau de disponibilité pour ce véhicule.</p>';
            calendarBox.innerHTML = '';
            return;
        }

        let html = '<ul>';
        for (const d of ranges) {
            html += `<li><strong>Du ${escapeHtml(formatISO(d.dateDebut))}</strong> au <strong>${escapeHtml(formatISO(d.dateFin))}</strong></li>`;
        }
        html += '</ul>';
        disposBox.innerHTML = html;

        const firstStart = parseISODate(ranges[0].dateDebut);
        const year = firstStart.getFullYear();
        const month = firstStart.getMonth();

        const availSet = buildAvailSet(ranges);

        const cal1 = renderCalendarForMonth(year, month, availSet);
        const nextDate = new Date(year, month + 1, 1);
        const cal2 = renderCalendarForMonth(nextDate.getFullYear(), nextDate.getMonth(), availSet);

        calendarBox.innerHTML = `<div class="grid">${cal1}${cal2}</div>`;
    }

    async function loadDispos(idLouable) {
        disposBox.innerHTML = '<p>Chargement...</p>';
        calendarBox.innerHTML = '';
        try {
            const res = await fetch(`/louer/disponibilites?idLouable=${encodeURIComponent(idLouable)}`);
            if (!res.ok) throw new Error('Erreur HTTP ' + res.status);
            const data = await res.json();
            renderDispos(data);
        } catch (e) {
            disposBox.innerHTML = `<p class="err">Impossible de charger les disponibilités : ${escapeHtml(e.message)}</p>`;
            calendarBox.innerHTML = '';
        }
    }

    function initLieuPrise() {
        const opt = selectLouable.options[selectLouable.selectedIndex];
        if (!opt) return;
        const lieu = opt.getAttribute('data-lieu') || '';
        lieuPriseAffiche.value = lieu;
    }

    selectLouable.addEventListener('change', () => {
        initLieuPrise();
        const id = selectLouable.value;
        if (id) loadDispos(id);
    });

    window.addEventListener('DOMContentLoaded', () => {
        initLieuPrise();
        const id = selectLouable.value;
        if (id) loadDispos(id);
    });
</script>

</body>
</html>