<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Entretiens techniques - <span th:text="${vehicle.marque()}"></span> <span th:text="${vehicle.modele()}"></span></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1>Entretiens techniques</h1>
        
        <!-- En-t√™te avec info v√©hicule -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">
                    V√©hicule: <span th:text="${vehicle.marque()}"></span> 
                    <span th:text="${vehicle.modele()}"></span>
                    (<span th:text="${vehicle.immatriculation()}"></span>)
                </h5>
                
                <!-- Statistiques -->
                <div class="row mt-3">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6 class="card-title">Total entretiens</h6>
                                <h3 th:text="${entretiens.size()}">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6 class="card-title">Co√ªt total</h6>
                                <h3 th:text="${coutTotal != null ? '‚Ç¨ ' + #numbers.formatDecimal(coutTotal, 1, 2) : '‚Ç¨ 0,00'}">‚Ç¨ 0,00</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6 class="card-title">Dernier entretien</h6>
                                <h6 th:if="${derniersEntretiens != null and !derniersEntretiens.isEmpty()}" 
                                    th:text="${derniersEntretiens[0].dateEntretien}">
                                </h6>
                                <h6 th:if="${derniersEntretiens == null or derniersEntretiens.isEmpty()}" 
                                    class="text-muted">Aucun</h6>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Boutons d'action -->
        <div class="mb-3">
            <a th:href="@{'/vehicles/' + ${vehicle.louable().idLouable()} + '/entretiens/nouveau'}" 
               class="btn btn-success">+ Nouvel entretien</a>
            <a th:href="@{'/vehicles/' + ${vehicle.louable().idLouable()} + '/controles-techniques/'}" 
               class="btn btn-info">üìã Voir contr√¥les techniques</a>
            <a th:href="@{/louables?vehicule=true}" class="btn btn-secondary">‚Üê Retour aux v√©hicules</a>
        </div>
        
        <!-- Derniers entretiens (vue rapide) -->
        <div th:if="${derniersEntretiens != null and !derniersEntretiens.isEmpty()}" class="mb-4">
            <h3>Derniers entretiens (5 plus r√©cents)</h3>
            <div class="list-group">
                <a th:each="entretien : ${derniersEntretiens}" 
                   th:href="@{'/vehicles/' + ${vehicle.louable().idLouable()} + '/entretiens/' + ${entretien.id}}"
                   class="list-group-item list-group-item-action">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1" th:text="${entretien.libelle}">Libell√©</h6>
                        <small th:text="${entretien.dateEntretien}">Date</small>
                    </div>
                    <p class="mb-1">
                        <span th:if="${entretien.prestataire}" th:text="${entretien.prestataire}"></span>
                        <span th:if="${entretien.cout != null}" 
                              th:text="' - ‚Ç¨ ' + #numbers.formatDecimal(entretien.cout, 1, 2)"></span>
                    </p>
                </a>
            </div>
        </div>
        
        <!-- Tableau complet des entretiens -->
        <h2>Historique complet</h2>
        <div th:if="${entretiens != null and !entretiens.isEmpty()}">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Libell√©</th>
                        <th>Prestataire</th>
                        <th>Co√ªt</th>
                        <th>Kilom√©trage</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="entretien : ${entretiens}">
                        <td th:text="${entretien.dateEntretien}"></td>
                        <td th:text="${entretien.libelle}"></td>
                        <td>
                            <span th:if="${entretien.prestataire}" th:text="${entretien.prestataire}"></span>
                            <span th:unless="${entretien.prestataire}" class="text-muted">-</span>
                        </td>
                        <td>
                            <span th:if="${entretien.cout != null}" 
                                  th:text="${'‚Ç¨ ' + #numbers.formatDecimal(entretien.cout, 1, 2)}"></span>
                            <span th:if="${entretien.cout == null}" class="text-muted">-</span>
                        </td>
                        <td>
                            <span th:if="${entretien.kilometrageEffectue != null}" 
                                  th:text="${entretien.kilometrageEffectue + ' km'}"></span>
                            <span th:if="${entretien.kilometrageEffectue == null}" class="text-muted">-</span>
                        </td>
                        <td>
                            <a th:href="@{'/vehicles/' + ${vehicle.louable().idLouable()} + '/entretiens/' + ${entretien.id}}" 
                               class="btn btn-sm btn-info">D√©tails</a>
                            <form th:action="@{'/vehicles/' + ${vehicle.louable().idLouable()} + '/entretiens/' + ${entretien.id} + '/supprimer'}" 
                                  method="post" style="display: inline;">
                                <button type="submit" class="btn btn-sm btn-danger" 
                                        onclick="return confirm('Supprimer cet entretien ?')">Supprimer</button>
                            </form>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div th:if="${entretiens == null or entretiens.isEmpty()}" class="alert alert-info">
            Aucun entretien technique enregistr√© pour ce v√©hicule.
        </div>
        
        <p class="text-muted mt-3">Date du jour: <span th:text="${aujourdhui}"></span></p>
    </div>
</body>
</html>