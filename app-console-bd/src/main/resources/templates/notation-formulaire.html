<!-- FICHIER: src/main/resources/templates/notation-formulaire.html -->
<!doctype html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: layout('Noter un louable', ~{::section})}">

<section>
  <div class="panel soft">

    <div class="panel-head">
      <div>
        <h1 class="h1">Noter ce louable</h1>
        <div class="muted small" th:if="${contrat != null}">
          Contrat #<strong th:text="${idContrat}">0</strong>
        </div>
      </div>

      <div class="btnrow">
        <a class="btn" th:if="${returnUrl != null}" th:href="${returnUrl}">← Retour</a>
        <a class="btn" th:if="${returnUrl == null and idContrat != null}"
           th:href="@{/contrats/{id}(id=${idContrat})}">← Retour contrat</a>
        <a class="btn" th:if="${returnUrl == null and idContrat == null}" th:href="@{/profil}">← Retour profil</a>
      </div>
    </div>

    <div class="hr"></div>

    <div class="alert err" th:if="${erreur}" th:text="${erreur}">Erreur</div>
    <div class="alert warn" th:if="${message}" th:text="${message}">Message</div>

    <div class="card" th:if="${contrat != null}">
      <div class="card-title">Récapitulatif</div>

      <div class="kv">
        <div class="kv-row">
          <div class="k">Véhicule</div>
          <div class="v">
            <span th:text="${contrat.marque}">Marque</span>
            <span th:text="${contrat.modele}">Modèle</span>
          </div>
        </div>

        <div class="kv-row">
          <div class="k">Lieu</div>
          <div class="v" th:text="${contrat.lieu}">Lieu</div>
        </div>

        <div class="kv-row">
          <div class="k">Période</div>
          <div class="v">
            <span th:text="${#dates.format(contrat.dateDebut, 'dd/MM/yyyy')}">01/01/2026</span>
            → <span th:text="${#dates.format(contrat.dateFin, 'dd/MM/yyyy')}">07/01/2026</span>
          </div>
        </div>
      </div>
    </div>

    <div class="spacer"></div>

    <div class="card">
      <div class="card-title">Votre note</div>

      <form class="form" th:action="@{/notation/soumettre}" method="post">
        <input type="hidden" name="idContrat" th:value="${idContrat}" />
        <input type="hidden" name="returnUrl" th:if="${returnUrl != null}" th:value="${returnUrl}" />

        <div class="field">
          <div class="label">Notez chaque critère</div>
          <p class="help">Survolez puis cliquez : les étoiles à gauche se remplissent.</p>
        </div>

        <div class="field" th:if="${criteres == null or criteres.size() == 0}">
          <div class="alert warn">
            Aucun critère trouvé. Vérifie la table <strong>CRITERE_LOUABLE</strong>.
          </div>
        </div>

        <!-- Critères -->
        <div th:each="critere : ${criteres}" class="kv" style="margin-bottom:12px;">
          <div class="kv-row" style="align-items:center;">
            <div class="k" th:text="${critere.libelle}">Critère</div>

            <div class="v">
              <!-- IMPORTANT : ordre inversé (5..1) pour que ~ label colore vers la GAUCHE -->
              <div class="rating" aria-label="Notation">
                <input class="rating-input" type="radio"
                       th:id="${'c' + critere.id + '_5'}"
                       th:name="${'critere_' + critere.id}"
                       value="5" required />
                <label class="rating-star" th:for="${'c' + critere.id + '_5'}" aria-label="5">★</label>

                <input class="rating-input" type="radio"
                       th:id="${'c' + critere.id + '_4'}"
                       th:name="${'critere_' + critere.id}"
                       value="4" />
                <label class="rating-star" th:for="${'c' + critere.id + '_4'}" aria-label="4">★</label>

                <input class="rating-input" type="radio"
                       th:id="${'c' + critere.id + '_3'}"
                       th:name="${'critere_' + critere.id}"
                       value="3" />
                <label class="rating-star" th:for="${'c' + critere.id + '_3'}" aria-label="3">★</label>

                <input class="rating-input" type="radio"
                       th:id="${'c' + critere.id + '_2'}"
                       th:name="${'critere_' + critere.id}"
                       value="2" />
                <label class="rating-star" th:for="${'c' + critere.id + '_2'}" aria-label="2">★</label>

                <input class="rating-input" type="radio"
                       th:id="${'c' + critere.id + '_1'}"
                       th:name="${'critere_' + critere.id}"
                       value="1" />
                <label class="rating-star" th:for="${'c' + critere.id + '_1'}" aria-label="1">★</label>
              </div>

              <p class="help" style="margin-top:6px;">Obligatoire</p>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="field">
          <div class="label">Commentaire (optionnel)</div>
          <textarea class="input" id="commentaire" name="commentaire" rows="4"
                    placeholder="Décris ton expérience…"></textarea>
        </div>

        <div class="btnrow">
          <button class="btn primary" type="submit">Valider ma note</button>
          <a class="btn" th:if="${idContrat != null}" th:href="@{/contrats/{id}(id=${idContrat})}">Annuler</a>
          <a class="btn" th:if="${idContrat == null}" th:href="@{/profil}">Annuler</a>
        </div>
      </form>
    </div>

  </div>

  <!-- CSS : 5 étoiles, hover + sélection = jaune sur la GAUCHE -->
  <style>
    .rating{
      display:inline-flex;
      flex-direction:row-reverse;  /* clé : 5..1 affiché de gauche à droite, mais DOM inversé */
      gap:6px;
      align-items:center;
      justify-content:flex-end;
    }

    .rating-input{
      position:absolute;
      left:-9999px;
      width:1px;
      height:1px;
      overflow:hidden;
    }

    .rating-star{
      font-size:22px;
      line-height:1;
      cursor:pointer;
      user-select:none;
      color:rgba(255,255,255,.35); /* neutre sur ton thème sombre */
      transition:color .15s ease, transform .05s ease;
    }

    /* Hover : l’étoile survolée + toutes celles à gauche (grâce à row-reverse + ~) */
    .rating-star:hover,
    .rating-star:hover ~ .rating-star{
      color:#ffc107;
    }

    /* Sélection : l’étoile cochée + toutes celles à gauche */
    .rating-input:checked ~ .rating-star{
      color:#ffc107;
    }

    .rating-star:active{
      transform:translateY(1px);
    }
  </style>
</section>
</html>